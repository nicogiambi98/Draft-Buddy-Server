<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Draft Buddy – Public View</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background:#121212; color:#e6e6e6; }
    header { padding: 12px 16px; background: #0a5a3f; color: #fff; }
    main { padding: 16px; max-width: 1000px; margin: 0 auto; }
    .card { border: 1px solid #2a2a2a; border-radius: 10px; padding: 12px; margin: 12px 0; background: #1a1a1a; box-shadow: 0 2px 6px #0006; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .row > * { flex: 1 1 320px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #333; padding: 8px 10px; text-align: left; }
    th { background: #222; }
    .muted { opacity: .75; }
    .error { color: #ff6b6b; }
    .ok { color: #27d17f; }
    code { background: #0008; padding: 0 4px; border-radius: 4px; }
    a.btn { display: inline-block; padding: 6px 10px; border-radius: 6px; background: #0b6; color: #fff; text-decoration: none; }
    .pill { font-size: 12px; padding: 2px 6px; border-radius: 999px; background: #ffffff1a; }
    .bingo { display: flex; gap: 16px; align-items: stretch; flex-wrap: wrap; }
    .bingo-sidebar { flex: 0 0 280px; max-width: 100%; }
    .bingo-players { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-height: 280px; overflow: auto; padding-right: 4px; }
    .bingo-players .btn { background: #222; color: #eee; border: 1px solid #444; border-radius: 10px; padding: 10px 12px; cursor: pointer; box-shadow: 0 1px 2px #0006; }
    .bingo-players .btn:hover { background: #2a2a2a; }
    .bingo-players .btn.sel { background: #0b6; color: #fff; border-color: #0b6; }
    .bingo-grid { display: grid; grid-template-columns: repeat(3, minmax(64px, 1fr)); gap: 8px; }
    .bingo-cell { border: 1px solid #333; border-radius: 10px; padding: 12px; text-align: center; min-width: 64px; min-height: 64px; display: flex; align-items: center; justify-content: center; flex-direction: column; background:#1b1b1b; }
    .bingo-cell .bingo-lab { font-size: 12px; opacity: .9; margin-bottom: 6px; color:#ddd; line-height: 1.15; word-break: break-word; }
    .bingo-cell.checked { background: rgba(0,187,102,0.15); border-color: #0b6; }
    .bingo-cell.win { box-shadow: inset 0 0 0 2px #0b6; }
    @media (max-width: 700px){
      .bingo { flex-direction: column; }
      .bingo-sidebar { order: 2; }
    }
  </style>
  <script>
    // Manager id is injected by the backend by replacing __MANAGER_ID__ placeholder
    const MANAGER_ID = '__MANAGER_ID__';
    const BASE = location.origin;
    const SNAPSHOT_URL = `${BASE}/public/${MANAGER_ID}/snapshot.sqlite`;
    const VERSION_URL = `${BASE}/public/${MANAGER_ID}/version`;

    async function fetchText(url) {
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return await r.text();
    }
    async function fetchArrayBuffer(url) {
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return await r.arrayBuffer();
    }

    async function load() {
      const statusEl = document.getElementById('status');
      const versionEl = document.getElementById('version');
      const tablesEl = document.getElementById('tables');
      const summaryEl = document.getElementById('summary');

      try {
        const v = await fetchText(VERSION_URL);
        versionEl.textContent = v === '0' ? 'not available yet' : new Date(parseInt(v,10)*1000).toLocaleString();
      } catch (e) {
        versionEl.textContent = 'unknown';
      }

      let SQL;
      try {
        // Load sql.js from CDN (no server changes needed)
        const mod = await window.initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}` });
        SQL = mod;
      } catch (e) {
        statusEl.innerHTML = `<span class="error">Failed to load sql.js</span>`;
        console.error(e);
        return;
      }

      let dbBytes;
      try {
        dbBytes = new Uint8Array(await fetchArrayBuffer(SNAPSHOT_URL));
      } catch (e) {
        statusEl.innerHTML = `<span class="error">No snapshot available for <b>${MANAGER_ID}</b>. Ask your manager to upload from the app.</span>`;
        console.warn(e);
        return;
      }

      statusEl.innerHTML = `<span class="ok">Snapshot loaded (${(dbBytes.byteLength/1024).toFixed(1)} KB)</span>`;

      const db = new SQL.Database(dbBytes);

      // List tables
      const res = db.exec("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name");
      const tableNames = res.length ? res[0].values.flat() : [];
      if (tablesEl) tablesEl.innerHTML = tableNames.map(n => `<span class="pill">${n}</span>`).join(' ');

      // Dashboard sections
      try { renderActiveEventSection(db, tableNames); } catch (e) { console.warn(e); }
      try { renderPairingsSection(db, tableNames); } catch (e) { console.warn(e); }
      try { renderBingoSection(db, tableNames); } catch (e) { console.warn(e); }
      try { renderLeagueSection(db, tableNames); } catch (e) { console.warn(e); }

      // Populate generic table browser (hidden on public view)
      const selector = document.getElementById('tableSelector');
      if (selector) {
        for (const n of tableNames) {
          const opt = document.createElement('option');
          opt.value = n; opt.textContent = n; selector.appendChild(opt);
        }
        selector.addEventListener('change', () => showTable(db, selector.value));
        if (tableNames.length) showTable(db, tableNames[0]);
      }
    }

    function renderQuery(db, title, sql) {
      let rows = [];
      let columns = [];
      try {
        const r = db.exec(sql);
        if (r.length) {
          columns = r[0].columns;
          rows = r[0].values;
        }
      } catch (e) {
        console.warn('Query failed', e);
      }
      if (!columns.length) return '';
      const head = `<tr>${columns.map(c=>`<th>${escapeHtml(c)}</th>`).join('')}</tr>`;
      const body = rows.map(row => `<tr>${row.map(v => `<td>${escapeHtml(String(v))}</td>`).join('')}</tr>`).join('');
      return `<div class="card"><h3>${title}</h3><div class="table-wrap"><table>${head}${body}</table></div></div>`;
    }

    function showTable(db, name) {
      const out = document.getElementById('tableOut');
      out.innerHTML = renderQuery(db, `Table: ${name}`, `SELECT * FROM '${name}' LIMIT 500`);
    }

    function escapeHtml(s) { return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    function getSingle(db, sql) {
      try {
        const r = db.exec(sql);
        if (r.length && r[0].values.length) {
          const cols = r[0].columns;
          const vals = r[0].values[0];
          const obj = {};
          cols.forEach((c, i) => obj[c] = vals[i]);
          return obj;
        }
      } catch (e) { /* noop */ }
      return null;
    }

    function renderActiveEventSection(db, tableNames) {
      const el = document.getElementById('activeEvent');
      if (!tableNames.includes('events')) {
        el.innerHTML = '<p class="muted">No events table.</p>';
        return;
      }
      // Prefer explicit active status, otherwise most recent with current_round>0, otherwise latest
      let ev = getSingle(db, "SELECT id,name,type,rounds,current_round,status,round_start_ts FROM events WHERE status IN ('active','running') ORDER BY id DESC LIMIT 1");
      if (!ev) ev = getSingle(db, "SELECT id,name,type,rounds,current_round,status,round_start_ts FROM events WHERE IFNULL(current_round,0)>0 ORDER BY id DESC LIMIT 1");
      if (!ev) ev = getSingle(db, "SELECT id,name,type,rounds,current_round,status,round_start_ts FROM events ORDER BY id DESC LIMIT 1");
      if (!ev) {
        el.innerHTML = '<p class="muted">No events yet.</p>';
        return;
      }
      const when = ev.round_start_ts ? new Date(parseInt(ev.round_start_ts,10)*1000).toLocaleString() : '—';
      el.innerHTML = `
        <div><b>${escapeHtml(ev.name || 'Event')}</b> <span class="pill">${escapeHtml(ev.type||'')}</span></div>
        <div>Status: <b>${escapeHtml(ev.status||'unknown')}</b></div>
        <div>Round: <b>${ev.current_round ?? 0}</b> / ${ev.rounds ?? '?'}</div>
        <div>Round started: <span class="pill">${when}</span></div>
      `;
      // Cache active id for pairings
      window.__ACTIVE_EVENT_ID__ = ev.id;
      window.__ACTIVE_ROUND__ = ev.current_round ?? 0;
    }

    function renderPairingsSection(db, tableNames) {
      const el = document.getElementById('pairings');
      if (!tableNames.includes('matches')) {
        el.innerHTML = '<p class="muted">No matches table.</p>';
        return;
      }
      const evId = window.__ACTIVE_EVENT_ID__;
      const rnd = window.__ACTIVE_ROUND__;
      if (!evId || !rnd) {
        el.innerHTML = '<p class="muted">No active round.</p>';
        return;
      }
      const sql = `
        SELECT m.round,
               COALESCE(p1.nickname, p1.name, ep1.guest_name) AS p1name,
               COALESCE(p2.nickname, p2.name, ep2.guest_name) AS p2name,
               m.player1, m.player2,
               m.score_p1 AS s1,
               m.score_p2 AS s2,
               m.bye,
               ep1.id AS ep1_id,
               ep2.id AS ep2_id
        FROM matches m
        LEFT JOIN event_players ep1 ON ep1.id = m.player1
        LEFT JOIN event_players ep2 ON ep2.id = m.player2
        LEFT JOIN players p1 ON p1.id = ep1.player_id
        LEFT JOIN players p2 ON p2.id = ep2.player_id
        WHERE m.event_id = ${evId} AND m.round = ${rnd}
        ORDER BY m.id
      `;
      const r = db.exec(sql);
      if (!r.length || !r[0].values.length) {
        el.innerHTML = '<p class="muted">No pairings for current round.</p>';
        return;
      }
      const rows = r[0].values.map(v => {
        const p1name = v[1];
        const p2name = v[2];
        const s1 = v[5] != null ? v[5] : '';
        const s2 = v[6] != null ? v[6] : '';
        const bye = v[7] ? 1 : 0;
        const ep1id = v[8];
        const ep2id = v[9];
        let p1 = p1name || '';
        let p2 = p2name || '';
        if (bye) {
          if ((ep1id == null || ep1id === undefined) && (ep2id != null)) { p1 = 'BYE'; }
          else if ((ep2id == null || ep2id === undefined) && (ep1id != null)) { p2 = 'BYE'; }
          else { p1 = p1 || 'BYE'; p2 = p2 || 'BYE'; }
        }
        return [p1 || '—', s1, '-', p2 || '—', s2];
      });
      const head = `<tr><th>Player 1</th><th>Score</th><th></th><th>Player 2</th><th>Score</th></tr>`;
      const body = rows.map(row => `<tr>${row.map(x => `<td>${escapeHtml(String(x))}</td>`).join('')}</tr>`).join('');
      el.innerHTML = `<table>${head}${body}</table>`;
    }

    function renderBingoSection(db, tableNames) {
      const el = document.getElementById('bingo');
      if (!(tableNames.includes('bingo_players') && tableNames.includes('bingo_meta'))) {
        el.innerHTML = '<p class="muted">Bingo not configured.</p>';
        return;
      }
      const meta = getSingle(db, 'SELECT row0,row1,row2,col0,col1,col2,diag0,diag1,full, win_row0,win_row1,win_row2,win_col0,win_col1,win_col2,win_diag0,win_diag1,win_full FROM bingo_meta WHERE id=1');
      const q = `
        SELECT bp.player_id,
               COALESCE(p.nickname, p.name, 'Player') AS name,
               bp.c0,bp.c1,bp.c2,bp.c3,bp.c4,bp.c5,bp.c6,bp.c7,bp.c8
        FROM bingo_players bp
        INNER JOIN players p ON p.id = bp.player_id
        ORDER BY name ASC
      `;
      const r = db.exec(q);
      if (!r.length || !r[0].values.length) {
        el.innerHTML = '<p class="muted">No bingo players yet.</p>';
        return;
      }
      const cols = r[0].columns;
      const players = r[0].values.map(row => ({
        id: row[0],
        name: row[1],
        cells: row.slice(2, 11).map(x => !!x)
      }));
      // Build UI containers
      el.innerHTML = `
        ${meta ? renderBingoMeta(meta, players) : ''}
        <div class="bingo">
          <div style="flex:1; min-width:240px;">
            <div id="bingoGrid" class="bingo-grid"></div>
            <div id="bingoLines" class="muted" style="margin-top:6px"></div>
          </div>
          <div class="bingo-sidebar">
            <div id="bingoPlayers" class="bingo-players"></div>
          </div>
        </div>
      `;
      const listEl = document.getElementById('bingoPlayers');
      const gridEl = document.getElementById('bingoGrid');
      const linesEl = document.getElementById('bingoLines');
      // Load labels from DB if present; prefer DB only (no remote JSON fallback)
      let labels = ['1','2','3','4','5','6','7','8','9'];
      try {
        const lr = db.exec("SELECT id, title, name, label, text, description FROM bingo_achievements ORDER BY id ASC");
        if (lr.length && lr[0].values.length) {
          const tmp = new Array(9);
          const cols = lr[0].columns;
          const titleIdx = cols.indexOf('title');
          const nameIdx = cols.indexOf('name');
          const labelIdx = cols.indexOf('label');
          const textIdx = cols.indexOf('text');
          const descIdx = cols.indexOf('description');
          for (const row of lr[0].values) {
            const rawId = Number(row[0]);
            let slot = Number.isFinite(rawId) ? rawId : NaN;
            if (!Number.isNaN(slot)) {
              // Normalize 1..9 into 0..8
              if (slot >= 1 && slot <= 9) slot = slot - 1;
              if (slot >= 0 && slot < 9) {
                const lab = [titleIdx, nameIdx, labelIdx, textIdx, descIdx]
                  .map(i => (i >= 0 ? row[i] : undefined))
                  .find(v => v != null && String(v).trim().length > 0);
                if (lab != null) tmp[slot] = String(lab);
              }
            }
          }
          if (tmp.some(Boolean)) { labels = tmp.map((v,i)=> v ?? labels[i]); }
        }
      } catch(e) { /* ignore */ }
      let selected = players[0];
      function renderPlayerList() {
        listEl.innerHTML = players.map(p => `<button class="btn${p.id===selected.id?' sel':''}" data-id="${p.id}">${escapeHtml(p.name)}</button>`).join(' ');
        for (const btn of listEl.querySelectorAll('button')) {
          btn.addEventListener('click', () => {
            const id = parseInt(btn.getAttribute('data-id'), 10);
            selected = players.find(x => x.id === id) || selected;
            renderPlayerList();
            renderGrid();
          });
        }
      }
      function renderGrid() {
        const cells = selected.cells;
        const lines = [ [0,1,2], [3,4,5], [6,7,8], [0,3,6], [1,4,7], [2,5,8], [0,4,8], [2,4,6] ];
        const completeIdx = lines.map((idx, i) => idx.every(j => cells[j]) ? i : -1).filter(i => i >= 0);
        gridEl.innerHTML = labels.map((lab, i) => {
          const checked = cells[i];
          const inWin = completeIdx.some(ci => lines[ci].includes(i));
          return `<div class="bingo-cell${checked?' checked':''}${inWin?' win':''}"><div class="bingo-lab">${escapeHtml(String(lab))}</div>${checked? '✓' : ''}</div>`;
        }).join('');
        const lineNames = ['Row 1','Row 2','Row 3','Col 1','Col 2','Col 3','Diag ↘','Diag ↙'];
        linesEl.textContent = completeIdx.length ? `Completed: ${completeIdx.map(i=>lineNames[i]).join(', ')}` : 'No complete lines yet.';
      }
      renderPlayerList();
      renderGrid();
      // If DB lacks labels, try fetching from server-side achievements-old.json as a runtime fallback
      if (!hasDbLabels) {
        fetch(`${BASE}/public/${MANAGER_ID}/achievements.json`, { cache: 'no-store' })
          .then(r => r.ok ? r.json() : Promise.reject(new Error(`${r.status} ${r.statusText}`)))
          .then(j => {
            if (j && Array.isArray(j.achievements)) {
              const x = j.achievements.slice(0, 9).map(v => String(v));
              if (x.length === 9 && x.every(Boolean)) { labels = x; renderGrid(); }
            }
          })
          .catch(() => {/* ignore */});
      }
    }

    function renderBingoMeta(meta, players){
      const winnerLabel = (pid) => {
        if (pid == null) return '';
        const p = players.find(x => x.id === pid);
        return p ? p.name : `Player ${pid}`;
      };
      const chunks = [];
      if (meta.row0) chunks.push(`<span class="pill">Row 1${meta.win_row0?': '+winnerLabel(meta.win_row0):''}</span>`);
      if (meta.row1) chunks.push(`<span class="pill">Row 2${meta.win_row1?': '+winnerLabel(meta.win_row1):''}</span>`);
      if (meta.row2) chunks.push(`<span class="pill">Row 3${meta.win_row2?': '+winnerLabel(meta.win_row2):''}</span>`);
      if (meta.col0) chunks.push(`<span class="pill">Col 1${meta.win_col0?': '+winnerLabel(meta.win_col0):''}</span>`);
      if (meta.col1) chunks.push(`<span class="pill">Col 2${meta.win_col1?': '+winnerLabel(meta.win_col1):''}</span>`);
      if (meta.col2) chunks.push(`<span class="pill">Col 3${meta.win_col2?': '+winnerLabel(meta.win_col2):''}</span>`);
      if (meta.diag0) chunks.push(`<span class="pill">Diag ↘${meta.win_diag0?': '+winnerLabel(meta.win_diag0):''}</span>`);
      if (meta.diag1) chunks.push(`<span class="pill">Diag ↙${meta.win_diag1?': '+winnerLabel(meta.win_diag1):''}</span>`);
      if (meta.full) chunks.push(`<span class="pill">Full Bingo${meta.win_full?': '+winnerLabel(meta.win_full):''}</span>`);
      if (!chunks.length) return '';
      return `<div style="margin-bottom:6px">${chunks.join(' ')}</div>`;
    }

    function renderLeagueSection(db, tableNames) {
      const el = document.getElementById('league');
      if (!tableNames.includes('leagues')) {
        el.innerHTML = '<p class="muted">No leagues defined.</p>';
        return;
      }
      const lg = getSingle(db, 'SELECT id,name,start_ts,end_ts FROM leagues ORDER BY IFNULL(end_ts, 32503680000) DESC, start_ts DESC LIMIT 1');
      if (!lg) { el.innerHTML = '<p class="muted">No leagues found.</p>'; return; }
      // Aggregate wins across all matches since league start (events proxy via created_at)
      // Fallback: if events table exists, restrict to events created after league start
      let where = '';
      if (tableNames.includes('events')) {
        where = ` AND m.event_id IN (SELECT id FROM events WHERE IFNULL(strftime('%s', created_at), 0) >= ${lg.start_ts || 0} ${lg.end_ts ? `AND IFNULL(strftime('%s', created_at),0) <= ${lg.end_ts}`:''})`;
      }
      const sql = `
        WITH wins AS (
          SELECT player1 AS pid, SUM(CASE WHEN IFNULL(score_p1,0) > IFNULL(score_p2,0) THEN 1 ELSE 0 END) AS w,
                 SUM(CASE WHEN IFNULL(score_p1,0) < IFNULL(score_p2,0) THEN 1 ELSE 0 END) AS l
          FROM matches m WHERE IFNULL(bye,0)=0 ${where}
          UNION ALL
          SELECT player2 AS pid, SUM(CASE WHEN IFNULL(score_p2,0) > IFNULL(score_p1,0) THEN 1 ELSE 0 END) AS w,
                 SUM(CASE WHEN IFNULL(score_p2,0) < IFNULL(score_p1,0) THEN 1 ELSE 0 END) AS l
          FROM matches m WHERE IFNULL(bye,0)=0 ${where}
        )
        SELECT COALESCE(p.nickname,p.name,'Player') AS player, SUM(w) AS wins, SUM(l) AS losses
        FROM wins
        INNER JOIN players p ON p.id = pid
        GROUP BY pid
        HAVING (wins + losses) > 0
        ORDER BY wins DESC, losses ASC, player ASC
        LIMIT 50
      `;
      const r = db.exec(sql);
      const title = `${escapeHtml(lg.name || 'League')} ${lg.start_ts ? '('+new Date(lg.start_ts*1000).toLocaleDateString()+ (lg.end_ts? ' – '+new Date(lg.end_ts*1000).toLocaleDateString():'') +')' : ''}`;
      if (!r.length || !r[0].values.length) { el.innerHTML = `<div class="muted">No match data for ${title}.</div>`; return; }
      const head = `<tr><th>Player</th><th>Wins</th><th>Losses</th></tr>`;
      const body = r[0].values.map(v => `<tr><td>${escapeHtml(String(v[0]))}</td><td>${v[1]}</td><td>${v[2]}</td></tr>`).join('');
      el.innerHTML = `<div style="margin-bottom:6px"><b>${title}</b></div><table>${head}${body}</table>`;
    }

    window.addEventListener('DOMContentLoaded', load);
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js" referrerpolicy="no-referrer"></script>
</head>
<body>
  <header>
    <h2 style="margin:0">Draft Buddy – Public View <small class="muted">(<span id="managerId">__MANAGER_ID__</span>)</small></h2>
  </header>
  <main>
    <div class="row">
      <div class="card">
        <b>Snapshot version:</b> <span id="version" class="pill">checking…</span>
      </div>
    </div>

    <div class="card">
      <div id="status" class="muted">Loading…</div>
    </div>

    <div id="summary"></div>

    <div class="card" id="activeEventCard">
      <h3>Active Event</h3>
      <div id="activeEvent"></div>
    </div>

    <div class="card" id="pairingsCard">
      <h3>Current Round Pairings</h3>
      <div id="pairings"></div>
    </div>

    <div class="card" id="bingoCard">
      <h3>Bingo Progress</h3>
      <div id="bingo"></div>
    </div>

    <div class="card" id="leagueCard">
      <h3>League Standings</h3>
      <div id="league"></div>
    </div>

  </main>
</body>
</html>
